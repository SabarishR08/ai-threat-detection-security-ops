{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto fade-in">
    <!-- Page Header -->
    <div class="text-center mb-8">
        <h1 class="header-title text-3xl mb-4">
            <i class="fas fa-brain text-primary"></i> SOC Log Analyzer
        </h1>
        <p class="text-muted font-mono">AI-powered security log processing, threat detection, and incident insights</p>
    </div>

    <!-- Main Analysis Section -->
    <div class="neon-box p-6">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-accent-primary to-accent-secondary flex items-center justify-center">
                <i class="fas fa-file-code text-white"></i>
            </div>
            <div>
                <h3 class="text-xl font-bold text-white">Log Analysis Engine</h3>
                <p class="text-muted text-sm">Submit security logs for AI-driven threat analysis</p>
            </div>
        </div>

        <!-- Upload/Input Section -->
        <form id="logForm" class="space-y-4">
            <!-- Textarea -->
            <div>
                <label for="log_text" class="setting-label">
                    <i class="fas fa-terminal text-primary mr-2"></i> Paste Security Logs
                </label>
                <p class="setting-description">
                    Paste system, firewall, authentication, or application logs for threat analysis.
                </p>
                <textarea id="log_text" name="log_text" rows="8"
                    placeholder="Example: [2024-01-15 14:23:45] WARNING - Failed login attempt from 192.168.1.100 (user: admin)
[2024-01-15 14:24:10] CRITICAL - Multiple failed SSH attempts detected from 10.0.0.5
[2024-01-15 14:25:30] INFO - Firewall blocked suspicious outbound connection to 45.33.32.156:4444
[2024-01-15 14:26:15] ALERT - Unusual network traffic pattern detected from internal host 192.168.1.50..."
                    class="log-textarea"></textarea>
                <div class="text-right mt-1">
                    <span id="charCount" class="text-xs text-muted font-mono">0 characters</span>
                </div>
            </div>

            <!-- File Upload -->
            <div>
                <label class="setting-label">
                    <i class="fas fa-upload text-primary mr-2"></i> Upload Log File
                </label>
                <p class="setting-description">
                    Supported formats: .log, .txt, .json (Optional)
                </p>
                <div class="file-upload-container">
                    <div class="file-upload-area" id="fileDropZone">
                        <i class="fas fa-cloud-upload-alt text-3xl text-primary mb-3"></i>
                        <p class="text-white mb-2 font-medium">Drop a file here, or click to browse</p>
                        <p class="text-muted text-sm">Supported formats: .log, .txt, .json — Max 10MB</p>
                        <input type="file" class="file-input" id="log_file" name="log_file" 
                               accept=".log,.txt,.json">
                    </div>
                    <div id="fileName" class="mt-2 text-sm text-muted"></div>
                </div>
            </div>

            <button type="submit" class="neon-button w-full">
                <i class="fas fa-brain mr-2"></i> Analyze Logs
            </button>
        </form>

        <!-- Results -->
        <div id="results" class="hidden mt-8">
            <!-- Results will be injected here -->
        </div>

        <!-- Message Box for Errors/Info -->
        <div id="messageBox" class="hidden mt-4 p-4 rounded-lg"></div>
    </div>
</div>

<style>
/* File Upload Styling */
.file-upload-container {
    margin-bottom: 1rem;
}

.file-upload-area {
    position: relative;
    padding: 2.5rem;
    border: 2px dashed var(--glass-border);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.02);
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: var(--accent-primary);
    background: rgba(3, 233, 244, 0.05);
}

.file-upload-area.dragover {
    border-color: var(--status-success);
    background: rgba(57, 255, 20, 0.1);
    transform: scale(1.02);
}

.file-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

/* Log Textarea */
.log-textarea {
    width: 100%;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    color: var(--text-main);
    font-family: monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    resize: vertical;
    transition: all 0.3s ease;
}

.log-textarea:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 2px rgba(3, 233, 244, 0.1);
}

.log-textarea::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

/* Animation */
.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Threat Card */
.threat-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-left: 4px solid var(--status-danger);
}

/* Stat Cards */
.stat-card {
    padding: 1.25rem;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    text-align: center;
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.8));
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    font-family: var(--font-mono);
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Responsive */
@media (max-width: 768px) {
    .file-upload-area {
        padding: 1.5rem;
    }
    
    .log-textarea {
        font-size: 0.8125rem;
    }
}
</style>

<script>
// File upload drag and drop
const dropZone = document.getElementById('fileDropZone');
const fileInput = document.getElementById('log_file');
const fileName = document.getElementById('fileName');
const logTextarea = document.getElementById('log_text');
const charCount = document.getElementById('charCount');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone on drag
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('dragover');
    });
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('dragover');
    });
});

// Handle file drop
dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length) {
        handleFile(files[0]);
    }
}

// Handle file selection via click
fileInput.addEventListener('change', function(e) {
    if (e.target.files.length) {
        handleFile(e.target.files[0]);
    }
});

function handleFile(file) {
    // Validate file size (10MB max)
    if (file.size > 10 * 1024 * 1024) {
        showMessage("File size should be less than 10MB", "error");
        return;
    }
    
    // Update file input
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(file);
    fileInput.files = dataTransfer.files;
    
    // Update file name
    fileName.textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
    fileName.className = 'mt-2 text-sm text-status-success';
    
    showMessage("Log file loaded successfully!", "success");
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Character counter for textarea
logTextarea.addEventListener('input', function() {
    const length = this.value.length;
    charCount.textContent = `${length} characters`;
    
    if (length > 10000) {
        charCount.classList.add('text-status-danger');
        charCount.classList.remove('text-status-warning', 'text-primary');
    } else if (length > 5000) {
        charCount.classList.add('text-status-warning');
        charCount.classList.remove('text-status-danger', 'text-primary');
    } else {
        charCount.classList.add('text-primary');
        charCount.classList.remove('text-status-danger', 'text-status-warning');
    }
});

// Initialize character count
logTextarea.dispatchEvent(new Event('input'));

// Message display function
function showMessage(message, type = "info") {
    const box = document.getElementById('messageBox');
    const colors = {
        success: 'bg-gradient-to-r from-green-900/30 to-green-800/20 border border-green-600 text-green-200',
        error: 'bg-gradient-to-r from-red-900/30 to-red-800/20 border border-red-600 text-red-200',
        warning: 'bg-gradient-to-r from-amber-900/30 to-amber-800/20 border border-amber-600 text-amber-200',
        info: 'bg-gradient-to-r from-blue-900/30 to-blue-800/20 border border-blue-600 text-blue-200'
    };

    box.className = `mt-4 p-4 rounded-lg ${colors[type]}`;
    box.innerHTML = `
        <div class="flex items-center gap-3">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 
                              type === 'error' ? 'exclamation-circle' : 
                              type === 'warning' ? 'exclamation-triangle' : 
                              'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    box.classList.remove('hidden');
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        box.classList.add('hidden');
    }, 3000);
}

// Main form submission
document.getElementById("logForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const logText = logTextarea.value.trim();
    const logFile = fileInput.files[0];
    
    if (!logText && !logFile) {
        showMessage("Please paste logs or upload a log file.", "warning");
        return;
    }

    const loader = document.getElementById("loader");
    const resultBox = document.getElementById("results");
    const messageBox = document.getElementById("messageBox");

    // Clear previous results
    resultBox.innerHTML = '';
    messageBox.classList.add('hidden');
    
    // Show loading state
    loader.classList.remove("hidden");
    resultBox.classList.add("hidden");

    try {
        const formData = new FormData();
        
        // Add text or file to form data
        if (logText) {
            formData.append('log_text', logText);
        }
        if (logFile) {
            formData.append('log_file', logFile);
        }

        const response = await fetch("/soc-analyzer", {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        if (response.ok) {
            loader.classList.add("hidden");
            resultBox.classList.remove("hidden");
            showMessage("Analysis complete!", "success");
            
            // Render results
            renderResults(data);
        } else {
            showMessage(data.error || "Failed to analyze logs", "error");
        }

    } catch (err) {
        console.error(err);
        showMessage("Error analyzing logs: " + err.message, "error");
    } finally {
        loader.classList.add("hidden");
    }
});

function renderResults(data) {
    const resultBox = document.getElementById('results');
    const aiAnalysis = data.ai_analysis || {};
    const threats = aiAnalysis.threats || [];
    const recommendations = aiAnalysis.recommendations || [];
    
    let html = `
        <div class="border-t border-glass-border pt-6">
            <h4 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <i class="fas fa-chart-bar text-primary"></i> Analysis Results
            </h4>
            
            <!-- Summary -->
            <div class="mb-6 p-4 bg-glass-bg rounded-lg border border-glass-border">
                <label class="setting-label mb-2">Summary</label>
                <p class="text-white">${aiAnalysis.summary || 'No summary available'}</p>
                <div class="mt-3 flex items-center gap-2">
                    <span class="text-sm text-muted">Severity:</span>
                    <span class="px-3 py-1 rounded-full text-xs font-bold ${
                        aiAnalysis.severity === 'Critical' ? 'bg-red-900/50 text-red-200' :
                        aiAnalysis.severity === 'High' ? 'bg-orange-900/50 text-orange-200' :
                        aiAnalysis.severity === 'Medium' ? 'bg-yellow-900/50 text-yellow-200' :
                        'bg-green-900/50 text-green-200'
                    }">${aiAnalysis.severity || 'Unknown'}</span>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="stat-card">
                    <div class="stat-value">${(data.ips_found || []).length}</div>
                    <div class="stat-label">IPs Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value ${threats.length > 0 ? 'text-status-danger' : 'text-status-success'}">
                        ${threats.length}
                    </div>
                    <div class="stat-label">Threats</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(data.rule_based_findings || []).length}</div>
                    <div class="stat-label">Findings</div>
                </div>
            </div>
    `;
    
    // Threats
    if (threats.length > 0) {
        html += `
            <div class="mb-6">
                <label class="setting-label mb-3">Detected Threats</label>
                <div class="space-y-3">
                    ${threats.map(threat => `
                        <div class="threat-card">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="font-bold text-white">${threat.type || 'Unknown Threat'}</h5>
                                <span class="text-xs px-2 py-1 rounded-full ${
                                    threat.severity === 'Critical' ? 'bg-red-900/50 text-red-200' :
                                    threat.severity === 'High' ? 'bg-orange-900/50 text-orange-200' :
                                    'bg-yellow-900/50 text-yellow-200'
                                }">${threat.severity || 'Medium'}</span>
                            </div>
                            ${threat.source_ips && threat.source_ips.length > 0 ? `
                                <p class="text-sm text-muted mb-1">Source IP Addresses:</p>
                                <div class="flex flex-wrap gap-1 mb-2">
                                    ${threat.source_ips.map(ip => `
                                        <span class="px-2 py-1 bg-glass-bg rounded text-xs font-mono">${ip}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${threat.attack_indicators && threat.attack_indicators.length > 0 ? `
                                <p class="text-sm text-muted mb-1">Attack Indicators:</p>
                                <ul class="text-sm text-white/90 space-y-1">
                                    ${threat.attack_indicators.map(ind => `<li>• ${ind}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Recommendations
    if (recommendations.length > 0) {
        html += `
            <div class="mb-6">
                <label class="setting-label mb-3">Recommended Actions</label>
                <ol class="list-decimal list-inside space-y-2">
                    ${recommendations.map(rec => `<li class="text-white">${rec}</li>`).join('')}
                </ol>
            </div>
        `;
    }
    
    // IP List
    if (data.ips_found && data.ips_found.length > 0) {
        html += `
            <div>
                <label class="setting-label mb-3">External IP Addresses</label>
                <div class="flex flex-wrap gap-2">
                    ${data.ips_found.map(ip => `
                        <span class="px-3 py-1 bg-glass-bg rounded-lg border border-glass-border text-sm font-mono">
                            ${ip}
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    html += `</div>`;
    resultBox.innerHTML = html;
}
</script>
{% endblock %}
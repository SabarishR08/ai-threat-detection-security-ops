{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto fade-in">
    <!-- Page Header -->
    <div class="text-center mb-8">
        <h1 class="header-title text-3xl mb-4">
            <i class="fas fa-qrcode text-primary"></i> QR Threat Detector
        </h1>
        <p class="text-muted font-mono">Scan QR codes for phishing threats & generate security test QR codes</p>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- ======================================
                LEFT COLUMN: QR GENERATOR
        ======================================= -->
        <div class="neon-box p-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-accent-primary to-accent-secondary flex items-center justify-center">
                    <i class="fas fa-qr-code text-white"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-white">QR Code Generator</h3>
                    <p class="text-muted text-sm">Generate QR codes for security testing</p>
                </div>
            </div>

            <div class="space-y-4">
                <!-- Payload Type Selector -->
                <div>
                    <label class="setting-label">
                        <i class="fas fa-layer-group text-primary mr-2"></i>Payload Type
                    </label>
                    <select id="payloadType" class="setting-input">
                        <option value="url">URL</option>
                        <option value="wifi">WiFi Network</option>
                        <option value="sms">SMS Message</option>
                        <option value="tel">Phone Call</option>
                        <option value="email">Email</option>
                        <option value="upi">UPI Payment</option>
                        <option value="text">Plain Text</option>
                    </select>
                </div>

                <!-- URL Payload -->
                <div id="urlFields">
                    <label class="setting-label">
                        <i class="fas fa-link text-primary mr-2"></i>Target URL
                    </label>
                    <div class="setting-description">
                        Enter any URL to generate a QR code (for phishing simulation or testing)
                    </div>
                    <input type="text" id="qrGenUrl" class="setting-input" 
                           placeholder="https://example.com/suspicious-page">
                </div>

                <!-- WiFi Payload -->
                <div id="wifiFields" style="display:none;" class="space-y-3">
                    <label class="setting-label">WiFi SSID</label>
                    <input type="text" id="wifiSSID" class="setting-input" placeholder="NetworkName">
                    <label class="setting-label">Security Type</label>
                    <select id="wifiSecurity" class="setting-input">
                        <option value="WPA">WPA</option>
                        <option value="WEP">WEP</option>
                        <option value="nopass">Open (No Password)</option>
                    </select>
                    <label class="setting-label">Password</label>
                    <input type="password" id="wifiPassword" class="setting-input" placeholder="Optional">
                </div>

                <!-- SMS Payload -->
                <div id="smsFields" style="display:none;" class="space-y-3">
                    <label class="setting-label">Phone Number</label>
                    <input type="tel" id="smsPhone" class="setting-input" placeholder="+1234567890">
                    <label class="setting-label">Message</label>
                    <textarea id="smsMessage" class="setting-input" placeholder="Message text" rows="2"></textarea>
                </div>

                <!-- Tel Payload -->
                <div id="telFields" style="display:none;">
                    <label class="setting-label">Phone Number</label>
                    <input type="tel" id="telPhone" class="setting-input" placeholder="+1234567890">
                </div>

                <!-- Email Payload -->
                <div id="emailFields" style="display:none;" class="space-y-3">
                    <label class="setting-label">Email Address</label>
                    <input type="email" id="emailAddr" class="setting-input" placeholder="victim@example.com">
                    <label class="setting-label">Subject</label>
                    <input type="text" id="emailSubject" class="setting-input" placeholder="Email subject">
                    <label class="setting-label">Body</label>
                    <textarea id="emailBody" class="setting-input" placeholder="Email body" rows="2"></textarea>
                </div>

                <!-- UPI Payload -->
                <div id="upiFields" style="display:none;" class="space-y-3">
                    <label class="setting-label">UPI ID</label>
                    <input type="text" id="upiId" class="setting-input" placeholder="user@upi">
                    <label class="setting-label">Amount</label>
                    <input type="number" id="upiAmount" class="setting-input" placeholder="100">
                    <label class="setting-label">Description</label>
                    <input type="text" id="upiDesc" class="setting-input" placeholder="Payment for...">
                </div>

                <!-- Text Payload -->
                <div id="textFields" style="display:none;">
                    <label class="setting-label">Text Content</label>
                    <textarea id="textContent" class="setting-input" placeholder="Plain text" rows="3"></textarea>
                </div>

                <button id="generateQRBtn" class="neon-button w-full">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <i class="fas fa-bolt mr-2"></i> Generate QR Code
                </button>
            </div>

            <!-- QR Preview -->
            <div id="qrPreviewSection" class="mt-8" style="display:none;">
                <div class="border-t border-glass-border pt-6">
                    <h4 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-eye text-primary"></i> Generated QR Code
                    </h4>
                    
                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <div class="flex-shrink-0">
                            <div class="p-4 bg-gradient-to-br from-[#0f172a] to-[#1e293b] rounded-xl border border-glass-border">
                                <img id="generatedQR" src="" alt="QR Code" 
                                     class="w-48 h-48 mx-auto">
                            </div>
                        </div>
                        
                        <div class="flex-1">
                            <div class="mb-4 p-4 bg-glass-bg rounded-lg border border-glass-border">
                                <p class="text-muted text-sm mb-2">URL Preview:</p>
                                <p id="qrUrlPreview" class="text-white font-mono text-sm break-all"></p>
                            </div>
                            
                            <div class="flex flex-wrap gap-3">
                                <button id="downloadQRBtn" class="action-button bg-gradient-to-r from-accent-primary to-accent-secondary">
                                    <i class="fas fa-download mr-2"></i> Download
                                </button>
                                <button id="copyQRBtn" class="action-button bg-gradient-to-r from-purple-500 to-pink-500">
                                    <i class="fas fa-copy mr-2"></i> Copy Image
                                </button>
                                <button id="shareQRBtn" class="action-button bg-gradient-to-r from-green-500 to-teal-400">
                                    <i class="fas fa-share-alt mr-2"></i> Share
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ======================================
                RIGHT COLUMN: QR SCANNER
        ======================================= -->
        <div class="neon-box p-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-status-warning to-orange-500 flex items-center justify-center">
                    <i class="fas fa-shield-alt text-white"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-white">QR Security Scanner</h3>
                    <p class="text-muted text-sm">Upload QR images to detect phishing threats</p>
                </div>
            </div>

            <form id="qrForm" enctype="multipart/form-data" class="space-y-4">
                <div class="file-upload-container">
                    <div class="file-upload-area" id="fileDropZone">
                        <i class="fas fa-cloud-upload-alt text-3xl text-primary mb-3"></i>
                        <p class="text-white mb-2">Drop QR image here or click to browse</p>
                        <p class="text-muted text-sm">Supports PNG, JPG, JPEG (Max 5MB)</p>
                        <input type="file" class="file-input" id="qr_image" name="qr_image" 
                               accept="image/*" required>
                    </div>
                    <div id="fileName" class="mt-2 text-sm text-muted"></div>
                    <div id="filePreview" class="mt-4" style="display: none;">
                        <img id="previewImage" src="" alt="Preview" class="max-w-full h-48 object-contain rounded-lg border border-glass-border">
                    </div>
                </div>

                <button type="submit" class="neon-button w-full" style="--accent-primary: var(--status-warning);">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <i class="fas fa-search mr-2"></i> Scan for Threats
                </button>
            </form>

            <!-- Scan Results -->
            <div id="scanResult" class="mt-8" style="display:none;">
                <div class="border-t border-glass-border pt-6">
                    <h4 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-primary"></i> Scan Results
                    </h4>
                    
                    <!-- Threat Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="stat-card bg-gradient-to-br from-[#0f172a] to-[#1e293b]">
                            <div class="stat-value" id="totalUrls">0</div>
                            <div class="stat-label">URLs Found</div>
                        </div>
                        <div class="stat-card bg-gradient-to-br from-[#0f172a] to-[#1e293b]">
                            <div class="stat-value text-status-success" id="safeCount">0</div>
                            <div class="stat-label">Safe URLs</div>
                        </div>
                        <div class="stat-card bg-gradient-to-br from-[#0f172a] to-[#1e293b]">
                            <div class="stat-value text-status-danger" id="threatCount">0</div>
                            <div class="stat-label">Threats Found</div>
                        </div>
                    </div>
                    
                    <!-- QR Content -->
                    <div class="mb-6 p-4 bg-glass-bg rounded-lg border border-glass-border">
                        <label class="setting-label mb-2">QR Code Content</label>
                        <div class="bg-[#0f172a] p-3 rounded border border-glass-border">
                            <code id="qrContent" class="text-white font-mono text-sm break-all"></code>
                        </div>
                    </div>
                    
                    <!-- Results Table -->
                    <div class="overflow-x-auto">
                        <table class="threat-table">
                            <thead>
                                <tr>
                                    <th>URL</th>
                                    <th>Status</th>
                                    <th>Severity</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTable"></tbody>
                        </table>
                    </div>
                    
                    <!-- Threat Alert Card -->
                    <div id="qrAlertCard" class="mt-6 p-5 rounded-xl border-l-4" style="display:none;">
                        <div class="flex items-start gap-3">
                            <div id="qrAlertIcon" class="text-2xl"></div>
                            <div>
                                <h5 id="qrAlertTitle" class="font-bold text-lg mb-1"></h5>
                                <p id="qrAlertMessage" class="text-sm"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* File Upload Styling */
.file-upload-container {
    margin-bottom: 1rem;
}

.file-upload-area {
    position: relative;
    padding: 2.5rem;
    border: 2px dashed var(--glass-border);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.02);
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: var(--accent-primary);
    background: rgba(3, 233, 244, 0.05);
}

.file-upload-area.dragover {
    border-color: var(--status-success);
    background: rgba(57, 255, 20, 0.1);
    transform: scale(1.02);
}

.file-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

/* Stat Cards */
.stat-card {
    padding: 1.25rem;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    font-family: var(--font-mono);
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Action Buttons */
.action-button {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: none;
    color: white;
    font-weight: 600;
    font-family: var(--font-main);
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

/* Threat Table */
.threat-table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
    overflow: hidden;
}

.threat-table thead {
    background: rgba(255, 255, 255, 0.05);
}

.threat-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-main);
    border-bottom: 1px solid var(--glass-border);
    font-family: var(--font-mono);
}

.threat-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--glass-border);
}

.threat-table tr:last-child td {
    border-bottom: none;
}

.threat-table tr:hover {
    background: rgba(255, 255, 255, 0.03);
}

/* Status Badges */
.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.status-malicious {
    background: rgba(255, 49, 49, 0.15);
    color: var(--status-danger);
    border: 1px solid var(--status-danger);
}

.status-suspicious {
    background: rgba(255, 184, 0, 0.15);
    color: var(--status-warning);
    border: 1px solid var(--status-warning);
}

.status-safe {
    background: rgba(57, 255, 20, 0.15);
    color: var(--status-success);
    border: 1px solid var(--status-success);
}

/* File Preview */
#filePreview {
    animation: fadeIn 0.3s ease-out;
}

#previewImage {
    max-height: 200px;
    margin: 0 auto;
}

/* Responsive */
@media (max-width: 768px) {
    .grid.grid-cols-1.lg\\:grid-cols-2 {
        grid-template-columns: 1fr;
    }
    
    .neon-box {
        padding: 1.5rem;
    }
    
    .stat-card {
        padding: 1rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
    }
    
    .file-upload-area {
        padding: 1.5rem;
    }
}
</style>

<script>
/* =====================================================
      Fixed Drag & Drop Implementation
===================================================== */
const fileDropZone = document.getElementById('fileDropZone');
const fileInput = document.getElementById('qr_image');
const fileName = document.getElementById('fileName');
const filePreview = document.getElementById('filePreview');
const previewImage = document.getElementById('previewImage');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    fileDropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone on drag
['dragenter', 'dragover'].forEach(eventName => {
    fileDropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    fileDropZone.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    fileDropZone.classList.add('dragover');
}

function unhighlight() {
    fileDropZone.classList.remove('dragover');
}

// Handle file drop
fileDropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length) {
        handleFiles(files);
    }
}

// Handle file selection via click
fileInput.addEventListener('change', function(e) {
    if (e.target.files.length) {
        handleFiles(e.target.files);
    }
});

function handleFiles(files) {
    const file = files[0];
    
    // Validate file type
    if (!file.type.match('image.*')) {
        showToast("Please select an image file (PNG, JPG, JPEG)", "error");
        return;
    }
    
    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        showToast("File size should be less than 5MB", "error");
        return;
    }
    
    // Update file input
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(file);
    fileInput.files = dataTransfer.files;
    
    // Update file name
    fileName.textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
    fileName.className = 'mt-2 text-sm text-status-success';
    
    // Show preview
    const reader = new FileReader();
    reader.onload = function(e) {
        previewImage.src = e.target.result;
        filePreview.style.display = 'block';
    };
    reader.readAsDataURL(file);
    
    showToast("QR image loaded successfully!", "success");
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

/* =====================================================
      QR Generation - Multi-Payload Support
===================================================== */

// Handle payload type selector
document.getElementById("payloadType").addEventListener("change", function() {
    const type = this.value;
    
    // Hide all field containers
    document.getElementById("urlFields").style.display = "none";
    document.getElementById("wifiFields").style.display = "none";
    document.getElementById("smsFields").style.display = "none";
    document.getElementById("telFields").style.display = "none";
    document.getElementById("emailFields").style.display = "none";
    document.getElementById("upiFields").style.display = "none";
    document.getElementById("textFields").style.display = "none";
    
    // Show selected type fields
    switch(type) {
        case "url":
            document.getElementById("urlFields").style.display = "block";
            break;
        case "wifi":
            document.getElementById("wifiFields").style.display = "block";
            break;
        case "sms":
            document.getElementById("smsFields").style.display = "block";
            break;
        case "tel":
            document.getElementById("telFields").style.display = "block";
            break;
        case "email":
            document.getElementById("emailFields").style.display = "block";
            break;
        case "upi":
            document.getElementById("upiFields").style.display = "block";
            break;
        case "text":
            document.getElementById("textFields").style.display = "block";
            break;
    }
});

// Generate QR Button Handler
document.getElementById("generateQRBtn").addEventListener("click", async function() {
    const payloadType = document.getElementById("payloadType").value;
    const btn = this;
    const originalText = btn.innerHTML;
    
    // Collect payload data based on type
    let payload = {};
    payload.type = payloadType;
    
    switch(payloadType) {
        case "url":
            const url = document.getElementById("qrGenUrl").value.trim();
            if (!url) {
                showToast("Please enter a URL", "warning");
                return;
            }
            try {
                new URL(url);
            } catch {
                showToast("Please enter a valid URL (include http:// or https://)", "warning");
                return;
            }
            payload.url = url;
            break;
            
        case "wifi":
            const ssid = document.getElementById("wifiSSID").value.trim();
            if (!ssid) {
                showToast("WiFi SSID is required", "warning");
                return;
            }
            payload.ssid = ssid;
            payload.security = document.getElementById("wifiSecurity").value;
            payload.password = document.getElementById("wifiPassword").value.trim();
            break;
            
        case "sms":
            const smsPhone = document.getElementById("smsPhone").value.trim();
            if (!smsPhone) {
                showToast("Phone number is required", "warning");
                return;
            }
            payload.phone = smsPhone;
            payload.message = document.getElementById("smsMessage").value.trim();
            break;
            
        case "tel":
            const telPhone = document.getElementById("telPhone").value.trim();
            if (!telPhone) {
                showToast("Phone number is required", "warning");
                return;
            }
            payload.phone = telPhone;
            break;
            
        case "email":
            const email = document.getElementById("emailAddr").value.trim();
            if (!email) {
                showToast("Email address is required", "warning");
                return;
            }
            payload.email = email;
            payload.subject = document.getElementById("emailSubject").value.trim();
            payload.body = document.getElementById("emailBody").value.trim();
            break;
            
        case "upi":
            const upiId = document.getElementById("upiId").value.trim();
            if (!upiId) {
                showToast("UPI ID is required", "warning");
                return;
            }
            payload.upi_id = upiId;
            payload.amount = document.getElementById("upiAmount").value.trim();
            payload.description = document.getElementById("upiDesc").value.trim();
            break;
            
        case "text":
            const text = document.getElementById("textContent").value.trim();
            if (!text) {
                showToast("Text content is required", "warning");
                return;
            }
            payload.text = text;
            break;
    }
    
    // Show loading state
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating...';
    btn.disabled = true;
    
    try {
        // Send to backend API
        const response = await fetch("/api/generate-qr", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (response.ok && data.qr_code) {
            // Display the generated QR code
            document.getElementById("qrPreviewSection").style.display = "block";
            document.getElementById("generatedQR").src = "data:image/png;base64," + data.qr_code;
            document.getElementById("qrUrlPreview").textContent = data.payload || "QR Code generated successfully";
            
            showToast("QR code generated successfully!", "success");
        } else {
            showToast(data.error || "Failed to generate QR code", "error");
        }
    } catch (err) {
        console.error("QR generation error:", err);
        showToast("Error generating QR code", "error");
    } finally {
        // Reset button
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});

/* =====================================================
      Download/Copy/Share QR Code
===================================================== */
document.getElementById("downloadQRBtn").addEventListener("click", function() {
    const qrImg = document.getElementById("generatedQR");
    
    if (!qrImg.src) {
        showToast("No QR code to download", "warning");
        return;
    }
    
    // Create temporary link
    const link = document.createElement('a');
    link.href = qrImg.src;
    link.download = `qr-code-${Date.now()}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast("QR code downloaded!", "success");
});

document.getElementById("copyQRBtn").addEventListener("click", async function() {
    const qrImg = document.getElementById("generatedQR");
    
    if (!qrImg.src) {
        showToast("No QR code to copy", "warning");
        return;
    }
    
    try {
        // For cross-origin images, we need to fetch them first
        const response = await fetch(qrImg.src, { mode: 'cors' });
        const blob = await response.blob();
        
        // Copy to clipboard
        await navigator.clipboard.write([
            new ClipboardItem({
                [blob.type]: blob
            })
        ]);
        
        showToast("QR code copied to clipboard!", "success");
    } catch (err) {
        console.error('Copy failed:', err);
        // Fallback: copy image URL
        try {
            await navigator.clipboard.writeText(qrImg.src);
            showToast("QR code URL copied to clipboard!", "success");
        } catch (err2) {
            showToast("Failed to copy QR code", "error");
        }
    }
});

document.getElementById("shareQRBtn").addEventListener("click", async function() {
    const qrImg = document.getElementById("generatedQR");
    const url = document.getElementById("qrGenUrl").value.trim();
    
    if (!qrImg.src) {
        showToast("No QR code to share", "warning");
        return;
    }
    
    if (navigator.share) {
        try {
            await navigator.share({
                title: 'Security QR Code',
                text: `QR Code for: ${url}`,
                url: qrImg.src
            });
        } catch (err) {
            if (err.name !== 'AbortError') {
                console.log('Share cancelled or failed:', err);
            }
        }
    } else {
        // Fallback: copy URL to clipboard
        try {
            await navigator.clipboard.writeText(url);
            showToast("URL copied to clipboard for sharing", "success");
        } catch (err) {
            showToast("Failed to copy URL", "error");
        }
    }
});

/* =====================================================
      QR SCANNING (Original functionality preserved)
===================================================== */
document.getElementById("qrForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const fileInput = document.getElementById("qr_image");
    if (!fileInput.files.length) {
        showToast("Please select a QR image.", "warning");
        return;
    }

    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Scanning...';
    submitBtn.disabled = true;

    const formData = new FormData();
    formData.append("qr_image", fileInput.files[0]);

    try {
        const response = await fetch("/api/scan-qr", {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        if (response.ok) {
            document.getElementById("scanResult").style.display = "block";
            document.getElementById("qrContent").innerText = data.qr_content || "N/A";

            const tbody = document.getElementById("resultsTable");
            tbody.innerHTML = "";

            const analysis = data.analysis || {};
            let riskLevel = (analysis.risk_level || "low").toLowerCase();
            let riskSeverity = analysis.severity || (riskLevel === "high" ? "High" : riskLevel === "medium" ? "Medium" : "Low");
            let riskStatus = analysis.status || (riskLevel === "high" ? "Malicious" : riskLevel === "medium" ? "Suspicious" : "Safe");

            let totalUrls = 0;
            let safeCount = 0;
            let threatCount = 0;
            let anyMalicious = false;

            if (data.urls_found && data.urls_found.length) {
                totalUrls = data.urls_found.length;
                
                data.urls_found.forEach(url => {
                    const status = data.results[url] || "Unknown";
                    const severity = status === "Malicious" ? "High" :
                                     status === "Suspicious" ? "Medium" : "Low";

                    if (status === "Malicious") {
                        threatCount++;
                        anyMalicious = true;
                        riskLevel = "high";
                        riskSeverity = "High";
                        riskStatus = status;
                    } else if (status === "Safe") {
                        safeCount++;
                    }

                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td class="font-mono text-sm">
                            <a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline break-all">
                                ${url}
                            </a>
                        </td>
                        <td>
                            <span class="status-badge ${status === 'Malicious' ? 'status-malicious' :
                                                   status === 'Suspicious' ? 'status-suspicious' :
                                                   'status-safe'}">
                                ${status}
                            </span>
                        </td>
                        <td class="font-bold ${severity === 'High' ? 'text-status-danger' :
                                           severity === 'Medium' ? 'text-status-warning' :
                                           'text-status-success'}">
                            ${severity}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                const label = analysis.type ? analysis.type.toUpperCase() : "PAYLOAD";
                tbody.innerHTML = `
                    <tr>
                        <td class="font-mono text-sm break-all">${label}</td>
                        <td>
                            <span class="status-badge ${riskStatus === 'Malicious' ? 'status-malicious' :
                                                   riskStatus === 'Suspicious' ? 'status-suspicious' :
                                                   'status-safe'}">
                                ${riskStatus}
                            </span>
                        </td>
                        <td class="font-bold ${riskSeverity === 'High' ? 'text-status-danger' :
                                           riskSeverity === 'Medium' ? 'text-status-warning' :
                                           'text-status-success'}">
                            ${riskSeverity}
                        </td>
                    </tr>`;

                if (riskLevel === "high" || riskLevel === "medium") {
                    threatCount = 1;
                    anyMalicious = riskLevel === "high";
                } else {
                    safeCount = 1;
                }
            }

            // Update stats
            document.getElementById("totalUrls").textContent = totalUrls;
            document.getElementById("safeCount").textContent = safeCount;
            document.getElementById("threatCount").textContent = threatCount;

            // Show alert card (handles both URL and non-URL risks)
            showQRAlertCard(riskLevel, analysis.details || "");

        } else {
            showToast(data.error || "Failed to scan QR.", "error");
        }

    } catch (err) {
        console.error(err);
        showToast("Error scanning QR code", "error");
    } finally {
        // Reset button
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    }
});

/* =====================================================
      Show QR Alert Card
===================================================== */
function showQRAlertCard(riskLevel, details) {
    const card = document.getElementById("qrAlertCard");
    const icon = document.getElementById("qrAlertIcon");
    const title = document.getElementById("qrAlertTitle");
    const message = document.getElementById("qrAlertMessage");

    const risk = (riskLevel || "low").toLowerCase();
    const detailText = details || "";

    if (risk === "high") {
        card.className = "mt-6 p-5 rounded-xl border-l-4 border-l-status-danger bg-gradient-to-r from-red-900/20 to-transparent";
        icon.innerHTML = '<i class="fas fa-exclamation-triangle text-status-danger"></i>';
        title.textContent = "⚠️ High Threat Detected";
        title.className = "font-bold text-lg mb-1 text-status-danger";
        message.textContent = detailText || "This QR code contains malicious content. Do NOT trust it.";
        message.className = "text-sm text-white";
    } else if (risk === "medium" || risk === "needs_scan") {
        card.className = "mt-6 p-5 rounded-xl border-l-4 border-l-status-warning bg-gradient-to-r from-amber-900/20 to-transparent";
        icon.innerHTML = '<i class="fas fa-shield-alt text-status-warning"></i>';
        title.textContent = "⚠️ Suspicious QR Detected";
        title.className = "font-bold text-lg mb-1 text-status-warning";
        message.textContent = detailText || "This QR may trigger SMS/Call/Email or payment actions. Proceed with caution.";
        message.className = "text-sm text-white";
    } else {
        card.className = "mt-6 p-5 rounded-xl border-l-4 border-l-status-success bg-gradient-to-r from-green-900/20 to-transparent";
        icon.innerHTML = '<i class="fas fa-shield-check text-status-success"></i>';
        title.textContent = "✅ Security Verified";
        title.className = "font-bold text-lg mb-1 text-status-success";
        message.textContent = detailText || "No threats detected. This QR code appears safe to scan.";
        message.className = "text-sm text-white";
    }

    card.style.display = "block";
}

/* =====================================================
      Toast Notification
===================================================== */
function showToast(message, type = "info") {
    // Remove existing toast
    const existingToast = document.querySelector('.toast-notification');
    if (existingToast) {
        existingToast.remove();
    }

    // Create toast
    const toast = document.createElement('div');
    toast.className = `toast-notification fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
    
    // Set colors based on type
    const colors = {
        success: 'bg-gradient-to-r from-green-500 to-emerald-600 border-l-4 border-l-status-success',
        error: 'bg-gradient-to-r from-red-500 to-rose-600 border-l-4 border-l-status-danger',
        warning: 'bg-gradient-to-r from-amber-500 to-orange-600 border-l-4 border-l-status-warning',
        info: 'bg-gradient-to-r from-accent-primary to-accent-secondary border-l-4 border-l-accent-primary'
    };

    toast.className += ' ' + colors[type];
    
    toast.innerHTML = `
        <div class="flex items-center gap-3">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 
                              type === 'error' ? 'exclamation-circle' : 
                              type === 'warning' ? 'exclamation-triangle' : 
                              'info-circle'}"></i>
            <span class="font-medium">${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 10);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 300);
    }, 3000);
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    console.log("QR Threat Detector loaded successfully");
    console.log("Drag & drop functionality is active");
});
</script>
{% endblock %}